#  数据库中脏读、不可重复读、幻读

### 一.先来回顾一下什么是事务，以及事务的四大特征

事务
事务是一个不可分割的数据库操作序列,也是数据库并发控制的基本单位,其执行的结果将使数据库从一种一致性状态变迁到另一种一致性状态。事务是逻辑上的一组操作,**要么全部执行,要么全部不执行**
*事务简单的来说，就是要么全部执行，要么全部不执行*，成为一个最小的原子单位。

```java
事务的基本步骤：
1.开启事务
  START TRANSACTION 或者BEGIN
2.回滚事务（rollback）
3.提交事务
  COMMIT

1234567
```

事务的四大特征

1. **原子性**:事务是最小的执行单位,不允许分割。事务的原子性确保动作要么全部完成,要么完全不起作用

2. **一致性**:执行事务前后,数据保持一致,多个事务对同一个数据读取的结果是相同的。

3. **隔离性**:并发访问数据库时,一个用户的事务不被其他事务所干扰,各并发事务之间数据库是独立的

4. **持久性**:一个事务被提交之后。它对数据库中数据的改变是持久的,即使数据库发生故障也不应该对其有任何影响

##### 而我们今天的主题就是隔离性  

### 二 .SQL标准定义的四个隔离级别

1. **Read Uncommitted(读取未提交）😗**最低的隔离级别,允许读取尚未提交的数据变更,可能会导致脏读、幻读或不可重复读。

2. **Read Committed(读取已提交)😗**允许读取并发事务已经提交的数据,可以阻止脏读,但是幻读或不可重复读仍有可能发生。

3. **Repeatable Read(可重复读)😗**对同一字段的多次读取结果都是一致的,除非数据是被本身事务自己所修改,可以阻止脏读和不可重复读,但幻读仍有可能发生。

4. **Serializable(可串行化)😗**最高的隔离级别,完全服从AC|D的隔离级别。所有的事务依次逐个执行,这样事务之间就完全不可能产生干扰,也就是说,该级别**可以防止脏读、不可重复读以及幻读**。  
![脏读幻读](https://user-images.githubusercontent.com/108125193/192178758-82811081-71d9-4b32-b003-150c899b7060.png)


**虽然将事务设置为可串行化可以防止脏读，不可重复读和幻读，但是安全性升高之后，程序的执行效率会降低。**  

### 三.什么是脏读?幻读?不可重复读?

1. **脏读**(Drity Read):某个事务已更新一份数据,另一个事务在此时读取了同一份数据,由于某些原因,前一个事务RollBack了操作,则后个事务所读取的数据就会是不正确的。
   **经典案例1：**
   张三和李四银行账户都为1000，张三声称要给李四转账500，但是在数据库操作中张三update了数据（张三账户-500，李四账户+500）后，并未commit事务，此时李四的事务进行查询时就是一个临时数据（李四账户查询+500），此后张三未提交事务，进行回滚操作，则张三并未转账。    

2. **不可重复读**(Non- repeatable read):在一个事务的两次查询之中数据不一致,这可能是两次查询过程中间插入了个事务更新的原有的数据。
   **经典案例2：**
   张三在查询自己的余额时（开启一个事务），账户显示余额为1000，然后余额被转出500，再次查询时，余额变成了500.（此处需要注意，张三开启的事务为同一个，并未结束事务，两次查询结果不一样是不合理的，现实中在ATM机上查询->转账->查询，两次结果不一样可以是认为是分别开启了两次事务）  

3. **幻读**(Phantom Read):在一个事务的两次查询中数据笔数不一致,例如有一个事务查询了几列(RoW)数据,而另一个事务却在此时插入了新的几列数据,先前的事务在接下来的查询中,就会发现有几列数据是它先前所没有的。
   **经典案例3：**
   银行账户中，原有的数据没有改变，但是在**同一个事务**中，两次查询多了几行或者几列数据。
   原数据：
![111](https://user-images.githubusercontent.com/108125193/192178819-9fe17926-f2c6-4428-9065-1f60d5957e9a.png)

   第二次查询：
   ![222](https://user-images.githubusercontent.com/108125193/192178973-b64ba722-3633-4c87-b017-dbe08b179076.png)
